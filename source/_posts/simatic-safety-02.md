---
title: SIMATIC Safety -- 硬件篇
date: 2018-09-22 10:48:02
tags: [Siemens,Fail-Safe,Safety Function]
---
编者按：SIMATIC Safety 概实现**安全功能**之评估元件也，此前篇所得之结论。观其“评估”生平，叹其可感知防护设备、执行机构之故障，保**安全功能**之清名，何为？实为本篇之要务矣
***
### Passivation & Reintegration

相比于过程，我们可能更在乎于结果。如果我们的故障安全系统检测到了故障的发生，他会用怎样的行为去阻止这个可恶的故障，使其不会造成**安全功能**的失效呢？当然，一切都是自然的，事物会朝着他本应有的方向去发展，故障也理应会被我们解决。伴随着他的离开，我们的故障安全系统又该如何重新投入到常规的工作之中呢？这便引出了江湖中颇为著名的一对伉俪：

#### 钝化(passivation)  
- **F-Inputs** 安全输入模块提供替代值“0”作为通道的过程映像区值，即*不依赖于实际信号*；   
- **F-Outputs** 安全输出模块的通道直接断电，即*不依赖于过程映像区* ；  

何时会发生钝化？  
1. 从F-系统的启动阶段一直到CPU进入“运行”模式；  
2. F-CPU 和 F-I/O 之间出现PROFIsafe “通讯故障”；  
3. **F-I/O 或通道故障出现时(例如：短路、断线、交叉接线等 )；** 
4. 设置 F-I/O DB 内的参数 PASS_ON = 1  

当情况1/2/4发生后，系统定会对整个F模块上的所有通道进行钝化，无法从模块参数上加以控制；  
情况3（*我们此后的讨论重点*）发生后，即通道故障出现，是可以在F模块的参数中选择“单个通道钝化”或是“整个模板钝化”的。 
此时，指示灯状态何如？  
*F-CPU的ER红色闪烁，F-I/O的ER红色闪烁，故障通道的“F指示灯”红色常亮*  
当然，我们也一定会看到在系统自动生成的F-I/O DB 的输出参数 **QBAD == 1**，或者故障通道PII的**Valuse Status == 0**，提示我不行了

现在我们了解到 **钝化** 即我们对于故障的典型响应，这个过程中的**故障检测** 和 **钝化行为** 都是由*评估系统* 中的F-I/O模块决定完成的。
***

#### 解钝(reintegration)  
- **F-Inputs** 安全输入模块上通道的过程映像区重新提供正确的过程值；  
- **F-Outputs** 安全输出模块的通道输出状态重新由过程映像区的值决定；  
*换言之，F-I/O 她们已经不咳嗽了！*  

对于由故障造成的钝化（包含 *通道故障* 以及 *通讯故障* ），解除钝化，让其重获自由，是有一个前提条件的，那就是**故障的消除**。当然，这个“消除”的状态，也只能由F-I/O模块按照不同的检测机制给到我们。故障消除后，指示灯的状态又如何呢？  
*F-CPU的ER红色闪烁，F-I/O的ER红色闪烁，通道“信号指示灯”及通道“F指示灯”红绿交替闪烁*  
当然，我们也一定会看到在系统自动生成的 F-I/O DB 的输出参数 **ACK_REQ == 1** ,提示可以解钝了  
那如何来进行解钝呢？  
- **手动解钝**  
默认F-I/O DB的输入参数 **ACK_NEC == 1**，在情况2、3故障消失后，必须通过用户手动确认的方式进行重新集成，两种手动确认的方法任性：
  1. 手动对F-CPU进行重启，解除钝化（一般现场不用）；  
  2. 手动编程对F-I/O DB的输入参数 **ACK_REI** 进行操作，确认后解除钝化。只要 **ACK_REI** 有过0->1触发，模块解钝成功，该模块输出参数 **ACK_REQ**，**QBAD**, 自动恢复为0 。  
- **自动解钝**  
手动修改参数 **ACK_NEC=0**，在情况3故障消失后，模块会自动重新集成。**（注：针对于非“F-CPU 与 F-I/O之间”的通讯错误）**  
如果是情况2“通讯故障”，无论**ACK_NEC**是0或是1，一定要手动对**ACK_REI**进行0->1触发才能解钝。

好，那所谓 **解钝** 即F-I/O 又重新可用了，安全功能又重新上岗了，在这个过程中的**故障消除** 和 **解钝行为** 也都是由F-I/O模块决定完成的。
***
知道了结果，人们就要去追问原因。因为我们相信因果的必然性，我们相信会有着维系世界运转的严格逻辑网络之存在。当然，如果真实世界如我们这次讨论的机器世界和数学世界般完美就完美了。好吧，那就在这个完美的世界问出来吧，  

**为什么 F-I/O 模块能够检测到故障的发生和故障的消除呢？**   
*（注：我们在这里的 **故障** 专指和安全功能相关的故障，即通道和电源的正负短路，通道之间的短路，以及通道组之间的差异发生，因为这些功能会直接造成 **安全功能** 的失效，危险事件的发生）*

要解释这个问题，就要分别从F-Input 和 Output模块的硬件结构和参数设定来入手了
***
### F-Input 模块故障检测原理
我们下面的所有讨论，一个大的的设定是，由F-DI去帮着检测传感器侧的短路和差异故障。换言之，传感器自身是可以检测到这些故障的，尤其是在当今的电子技术条件下，很多防护设备的诊断覆盖率（Diagnostics Coverage）都可以到达99%了，什么错误人家自己都能发现。  
所以，下面所讨论的供电方式、接线方法实际上都不是绝对的，只要传感器自身足够牛，就根本不需要或者根本就不可以让**评估原件**帮助他来发现错误。

#### 1.短路故障检测   

F-DI模块上，每个通道都有一个与之配套的独立传感器供电电源VS， 向外提供24V直流电压。通道接线并组态时一定要选择内部VS作为其sensor supply，且该VS也一定要激活“Short circuit test”。*（都默认，别改就对了）*  

- 如何检测通道与外部L+电源的短路呢？  

原因很简单，就是这个“Short circuit test”的疗效。  
当短路测试使能后，对应的传感器供电电压会被周期性地关断组态的时间 *（即“Time for short circuit test”==4.2ms）*；否则，它将提供恒定的DC 24V电压。  
所以，如果F-DI模块在组态的关断时间内，在输入通道上没有检测到“0”信号，而是常1，则诊断中断就会产生，表明一定是有L+和该输入通道短路了。

- 如何检测通道与其他通道之间，或者与其他通道的VS短路呢？  

原因更简单，这个“Short circuit test”又立功了！  
因为每个通道VS的关断周期是不一样的。所以每个输入通道，对专属于自己的sensor supply的安全期，那是记得倍儿清啊。所以，在我自己VS关断的时候，如果还能在通道上检测到“1”信号，那一定也是能分辨出来的。  
他们能够知道是不是在我老公不在家的日子里，隔壁老王“悄悄送你来到我身边”……
***
#### 2.差异故障检测

**差异（discrepancy）** 检测仅针对于1oo2的评估方式，用于分析 *“检测单一防护设备”* 的 *“双通道传感器”* 是否存在故障的风险。其评估原理如下：  
- 只要该组内的两个通道值一致，就立即把这个值作为通道实际值，不会等你设置的差异时间结束；  
- 只要出现了通道值的不一致：  
  **在差异时间内**，通道的实际值等于你组态的0或者“last valid value”；在时间范围内重新一致后，则也是立即把这个值作为通道实际值；  
**超过了差异时间后**，如果仍然不一致，则报“差异故障”，通道被钝化掉。


***
### F-Output 模块故障检测原理

为了**安全功能**的正确实施，F-DO模块也需要在内部进行自我的故障检测，那检测什么呢？当然也是检测颇为致命的“短路”故障，包括输出通道（P X、M x）与（L+、M-）之间是否短路；以及通道之间是否发生短路。目的就是一定要保证分断时，执行机构能够安全的断开。  
*（注：和安全功能无关的断线诊断，“Light Test”不在本次讨论范围之内）*  

那F-DO通道上的短路情况是怎么被发现的呢？好，主角要登场了。接下来的所有讨论就都要紧密地团结在以 **“回读电路”** 为核心的党中央周围。  
所以，短路故障的检测就是基于**回读电路** 通过 **“Readback”回读值**（包含P回读和M回读）来进行判断的。我们就是要坚定不移地贯彻一个党，一个领袖，一个主义，让**回读值**终身制，他是永远正确，永远伟大，永远万岁的！别拦着我，我还没编完呢。

![](/images/0201.jpg)

诚然，**回读值**决定了一切，但是我们也得批评您，太不注意自己的身体了，太事必躬亲了，不行，我们得帮帮您，替您分忧，帮您解难。  

如上图所示，在F-DO模块内部，每组输出通道的Px、Mx内各有一个分断开关，即*P-swithch & M-switch*。在有些情况下，只有内部分断开关配合动作，才能使**回读电路**得到测试所用之**回读值**。  
当然，这个**测试动作** 无外乎就是分断开关的*关断* 或者 *接通*，而且这个配合**回读**的**测试动作** 一定是F-DO模块按照一定的周期自主进行的。好，掌声有请**测试动作**双飞入场，光明左使--**关断测试**，光明右使--**接通测试**
***
#### 1.Dark Test （关断测试） 

这是所有F-DO模块必须要进行的*测试动作*。  
在F-DO输出通道PIQ==1，外部执行器动作之时，通道内部P-switch、M-switch 均为接通状态。此时，由于通道正在被使用，所以一旦出现了前文所描述的短路情况发生，安全功能 一定会失效，造成执行机构无法分断。因此，对外围回路的短路检测必是箭在弦上，好，那到底是肿么检测的呢？ 

从原理上讲，此时一定要将P-switch和M-swithch关断，而后才能对外检测有没有短路电流进入回读电路形成回读值。但是，你一断switch，是不是就得害怕执行器真断了啊，所以这个必须是要交替断的，而且还得特别小心这个断的时间不能太长了，因为如果设的太长了，就真断了；当然太短了总是不好的，因为你可能又回读不到0。所以，要去试这个参数，找到一个另双方都满意的长度。  

此刻，就会有求知欲特别旺盛的天妒英才（注意这要倒口）闪动着无鞋的大眼睛，非要问我到底是长好还是短好那？  
首先，对于这个问题，我是非常乐于回答的，因为这是一个我从青少年时期就颇感兴趣并且常年累月孜孜不倦探寻的，并且梦想着为之付出一生的科学堡垒。这是一个我曾发誓一定要在有生之年采摘到的人类科学与文明金字塔顶的一朵瑰丽的后庭花。  
那好吧，既然大家都感性趣，什么鸡毛故障安全，咱们就到此为止吧，今儿就今儿啦。接下来我就要以洋洋洒洒八万字的巨幅篇章，以走进科学的视角带大家进入到一个令人发指的生命不能承受之长和寒冬夜行短！*（此处略去八万字）*  …………

综上，他们就为F-DO模块设计了一套检测机制，在通道接通时自动地关断F-DO模块内部P-switch、M-switch，进而通过**回读值**检测短路故障。这就是传说中的**Dark Test（关断测试）**  

记住两点：  
① 关断测试仅在输出通道等于1时进行，输出为0不做该测试；  
② 关断测试时P-swtich、M-swtich交替关断。  

测试原理：  
P/M-swtich关断的时间由一个参数 **max Readback time for “dark test”** 决定（0.6~400ms）。  
在测试过程中，P/M-switch始终为断开的，持续你所定义的**max readback time**。  
只有在你设定的**max readback time**时间到达后，才会真正去做**回读值**检测，如果状态是1，则通道报错、钝化。  
*注：switch是要真正断所定义的max Readback time，这个就不是最大值了。*
***
#### 2.Switch on Test （接通测试）
在F-DO输出通道PIQ==0，外部执行器尚无输出，通道内部P-swtich和M-swtich均为关断状态，**回读值**应该为0；如果出现了非0的值，则通道必有短路情况发生，应予报错、进行钝化。当然，由于通道尚未被征用，故此短路故障彼时相对是非决定性的，所以原来有些老的模块无此参数设置。   

好，那为什么会在P/M-swtich为关断状态时检测到1的**回读值**呢？  

##### 2.1 输出的Px与L+短路，或者Mx与M-短路  
只要上述任意短路出现，根据回读电路图，我的大F-DO一定会第一时间通过这个牛逼的Readback把他找出来，第一时间把通道钝化掉。（F4真牛逼！）  
根本就不需要P/M-swtich 分断开关做任何的配合动作，回读电路就可以通过**回读值**立即做出最终的裁决。所以后面所谓的测试周期根本就不用考虑，下面的 **接通测试** 亦不用考虑。  

##### 2.2 Cross Circuit 交叉电路  
指的是该通道输出的Px与其他通道输出的Py短路了；或者该通道输出的Mx与其他通道输出的My短路了。这挺高科技的啊，那这怎么查呢？  
根据回读电路图，此时一定要将P-swtich和M-swtich接通，而后才能形成回路进行回读测试。  
综上，他们也为F-DO模块设计了一个检测机制，在通道断开时自动地接通F-DO模块内部P-switch、M-switch，进而通过**回读值**检测短路故障。这就是传说中的**Switch on Test （接通测试）**  

记住两点：  
① 接通测试仅在输出通道等于0时进行，输出为1 不做该测试；  
② 接通测试时P-swtich、M-swtich交替接通，于负载上不形成真正的回路。

测试原理：
 
如果在规定的 **max Readback time for “switch on test”** 内，**回读值**==0，则该通道报错、钝化；在规定的时间内，只要**回读值**==1，代表通道OK，就马上结束测试，不用等最长的时间完全用完。*（范围：0.6~5.0 ms）*
***
#### 3.Test Period 测试周期
好嘞，两坨屎，你俩这么得瑟啊，得瑟，早晚得把我俩（P/M-swtich）玩儿坏了。  
不会，我们是有分寸的，内部开关的分和动作是不追随扫描周期，不追随安全运行组的，而是由F-DO模块自行决定的。  
这个测试周期，有些模块是固定的，比如ET200S的F-DO，**1000s**执行一次;有些模块是可以调整的，比如ET200SP的F-DO，**1000s、100s**两者二选一。  
不论固定还是可调周期，F-DO模块一旦检测到错误，钝化通道后，测试的周期都会被自动缩短到**60s**。保证安全模块能够频率更快地来进行测试，尽早地检测到短路故障的消失，恢复**安全功能**的正常工作。
***
好啦，结束



